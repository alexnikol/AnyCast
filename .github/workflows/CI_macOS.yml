name: CI macOS

on:
  push:
    branches: [ feature/code_coverage_codeclimate_integration ]

jobs:
  build-and-test:
    runs-on: macos-12
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v2

    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode_14.0.app
      
    - name: Xcode version
      run: /usr/bin/xcodebuild -version
      
    - name: Build and Test
      run: xcodebuild clean build test -project PodcastsComponents/PodcastsComponents/PodcastsComponents.xcodeproj -scheme "CI_macOS" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO -sdk macosx -destination "platform=macOS" ONLY_ACTIVE_ARCH=YES -resultBundlePath CImacOSResults -derivedDataPath /tmp/XcodeDerivedDataWithCoverage

    - uses: kishikawakatsumi/xcresulttool@v1
      with:
        path: CImacOSResults.xcresult
      if: success() || failure()

    - name: Slather install
      run: sudo gem install slather

    - name: Code coverage converting to cobertura.xml format
      run: slather coverage -x

    - name: CodeClimate Code Coverage Test Reporter
      uses: xylabs/action-code-climate-test-reporter@v1.0.0

    - name: Publish code coverage
      uses: paambaati/codeclimate-action@v3.2.0
      env:
        CC_TEST_REPORTER_ID: "${{ secrets.CC_TEST_REPORTER_ID }}"
      with:
        coverageCommand: npm run coverage
        workingDirectory: slather_reports/CI_macOS/
        debug: true